# Nginx configuration for Docker
# HTTP -> HTTPS redirect handled by upstream load balancer/Cloudflare

upstream frontend {
    server frontend:3000;
}

upstream backend {
    server backend:3001;
}

upstream judge0 {
    server judge0-server:2358;
}

server {
    listen 80;
    server_name _;
    
    client_max_body_size 50M;

    # Profile pictures - served directly
    location /pfps/ {
        alias /var/www/pfps/;
        expires 7d;
        add_header Cache-Control "public, max-age=604800";
        try_files $uri =404;
    }

    # Next.js API routes (these are implemented in the Next.js app)
    location ~ ^/api/(training-sheets|submissions|leaderboard|sheets|judge|stats|analyze-complexity|user|recap) {
        proxy_pass http://frontend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Backend API routes (Express - handles /auth, /admin, /profile, etc.)
    location /api/ {
        proxy_pass http://backend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 300s;
        proxy_connect_timeout 75s;
    }

    # Judge0 API (internal only, or exposed if needed)
    location /judge0/ {
        rewrite ^/judge0/(.*)$ /$1 break;
        proxy_pass http://judge0;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # Frontend (Next.js)
    location / {
        proxy_pass http://frontend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 300s;
        proxy_connect_timeout 75s;

        # Hide upstream CSP to avoid duplication/conflicts
        proxy_hide_header Content-Security-Policy;
        proxy_hide_header X-Frame-Options;

        # Set permissive CSP
        add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https: blob:; style-src 'self' 'unsafe-inline' https:; img-src 'self' data: blob: https:; font-src 'self' data: https:; connect-src 'self' https: blob:; media-src 'self' https:; frame-src 'self' https://drive.google.com https://www.youtube.com; object-src 'none'; frame-ancestors 'none'; upgrade-insecure-requests;" always;
        
        # Set X-Frame-Options
        add_header X-Frame-Options "SAMEORIGIN" always;
    }
}

# HTTPS server (if handling SSL directly)
server {
    listen 443 ssl;
    server_name www.icpchue.xyz;
    
    ssl_certificate /etc/letsencrypt/live/icpchue.xyz/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/icpchue.xyz/privkey.pem;

    return 301 https://icpchue.xyz$request_uri;
}

server {
    listen 443 ssl;
    server_name icpchue.xyz;
    
    ssl_certificate /etc/letsencrypt/live/icpchue.xyz/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/icpchue.xyz/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    
    client_max_body_size 50M;

    # Profile pictures
    location /pfps/ {
        alias /var/www/pfps/;
        expires 7d;
        add_header Cache-Control "public, max-age=604800";
        try_files $uri =404;
    }

    # Next.js API routes (these are implemented in the Next.js app)
    location ~ ^/api/(training-sheets|submissions|leaderboard|sheets|judge|stats|analyze-complexity|user|recap) {
        proxy_pass http://frontend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Backend API routes (Express - handles /auth, /admin, /profile, etc.)
    location /api/ {
        proxy_pass http://backend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 300s;
    }

    # Judge0 API
    location /judge0/ {
        rewrite ^/judge0/(.*)$ /$1 break;
        proxy_pass http://judge0;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # Frontend
    location / {
        proxy_pass http://frontend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 300s;
    }
}
