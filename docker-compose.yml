# ICPC HUE - Unified Docker Compose
# Run: docker compose up -d

x-logging: &default-logging
  driver: json-file
  options:
    max-size: "10m"
    max-file: "3"

services:
  # ===========================================
  # NGINX REVERSE PROXY
  # ===========================================
  nginx:
    image: nginx:alpine
    container_name: icpchue-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
      - ./pfps:/var/www/pfps:ro
      - /etc/letsencrypt:/etc/letsencrypt:ro
    depends_on:
      - frontend
      - backend
    networks:
      - icpchue-network
    restart: always
    logging: *default-logging

  # ===========================================
  # FRONTEND (Next.js)
  # ===========================================
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
    container_name: icpchue-frontend
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_SITE_URL=https://icpchue.xyz
    env_file:
      - ./next-app/.env.production
    depends_on:
      - backend
    networks:
      - icpchue-network
    restart: always
    logging: *default-logging
    volumes:
      - ./pfps:/app/pfps

  # ===========================================
  # BACKEND (Express)
  # ===========================================
  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
    container_name: icpchue-backend
    environment:
      - NODE_ENV=production
      - PORT=3001
    env_file:
      - ./server/.env
    volumes:
      - ./pfps:/app/pfps
    depends_on:
      - redis
    networks:
      - icpchue-network
    restart: always
    logging: *default-logging

  # ===========================================
  # JUDGE0 - CODE EXECUTION ENGINE
  # ===========================================
  judge0-server:
    image: judge0/judge0:latest
    container_name: icpchue-judge0-server
    volumes:
      - ./judge0/judge0.conf:/judge0.conf:ro
    ports:
      - "2358:2358"
    privileged: true
    depends_on:
      - judge0-db
      - redis
    networks:
      - icpchue-network
    restart: always
    logging: *default-logging

  judge0-worker:
    image: judge0/judge0:latest
    container_name: icpchue-judge0-worker
    command: ["./scripts/workers"]
    volumes:
      - ./judge0/judge0.conf:/judge0.conf:ro
    privileged: true
    depends_on:
      - judge0-db
      - redis
    networks:
      - icpchue-network
    restart: always
    logging: *default-logging

  judge0-db:
    image: postgres:16.2-alpine
    container_name: icpchue-judge0-db
    env_file: ./judge0/judge0.conf
    volumes:
      - judge0-db-data:/var/lib/postgresql/data
    networks:
      - icpchue-network
    restart: always
    logging: *default-logging

  # ===========================================
  # REDIS (For Judge0)
  # ===========================================
  redis:
    image: redis:7.2-alpine
    container_name: icpchue-redis
    command: ["redis-server", "--appendonly", "no", "--requirepass", "${REDIS_PASSWORD:-yourredispassword}"]
    volumes:
      - redis-data:/data
    networks:
      - icpchue-network
    restart: always
    logging: *default-logging

  # ===========================================
  # MAIL SERVER
  # ===========================================
  mailserver:
    image: mailserver/docker-mailserver:latest
    container_name: icpchue-mailserver
    hostname: mail
    domainname: icpchue.xyz
    ports:
      - "25:25"
      - "143:143"
      - "587:587"
      - "993:993"
    volumes:
      - ./mail-server/docker-data/dms/mail-data/:/var/mail/
      - ./mail-server/docker-data/dms/mail-state/:/var/mail-state/
      - ./mail-server/docker-data/dms/mail-logs/:/var/log/mail/
      - ./mail-server/docker-data/dms/config/:/tmp/docker-mailserver/
      - /etc/localtime:/etc/localtime:ro
      - /etc/letsencrypt:/etc/letsencrypt:ro
    environment:
      - ENABLE_SPAMASSASSIN=1
      - ENABLE_CLAMAV=0
      - ENABLE_FAIL2BAN=1
      - ENABLE_POSTGREY=0
      - ONE_DIR=1
      - DMS_DEBUG=0
      - PERMIT_DOCKER=connected-networks
      - SSL_TYPE=letsencrypt
      - SSL_DOMAIN=icpchue.xyz
    cap_add:
      - NET_ADMIN
    networks:
      - icpchue-network
    restart: always
    logging: *default-logging

# ===========================================
# NETWORKS
# ===========================================
networks:
  icpchue-network:
    driver: bridge

# ===========================================
# VOLUMES
# ===========================================
volumes:
  judge0-db-data:
  redis-data:
